.print Import data from snapshot file chembl_snapshot.csv
.mode csv
.import chembl_snapshot.csv chembl_snapshot


.print Show failed test_permutation_invariance:
SELECT chembl_id
FROM chembl_snapshot
WHERE passed_test_permutation_invariance = "False";


.print Show failed test_sumformula:
SELECT chembl_id, tucan
FROM chembl_snapshot
WHERE passed_test_sumformula = "False";


.print Show failed test_roundtrip_molfile_graph_tucan_graph_tucan_graph:
SELECT chembl_id
FROM chembl_snapshot
WHERE passed_test_roundtrip_molfile_graph_tucan_graph_tucan_graph = "False";


.print Create index on column 'chembl_id' ...
CREATE INDEX idx_chembl_snapshot_chembl_id ON chembl_snapshot (chembl_id);


.print Create index on column 'tucan' ...
CREATE INDEX idx_chembl_snapshot_tucan ON chembl_snapshot (tucan);


.print Show compounds with duplicate TUCAN strings
SELECT chembl_id, tucan
FROM chembl_snapshot
WHERE tucan IN (
  SELECT tucan
  FROM chembl_snapshot
  GROUP BY tucan
  HAVING COUNT(tucan) > 1
);


.print Attach original ChEMBL sqlite database
ATTACH DATABASE '../chembl_31/chembl_31_sqlite/chembl_31.db' AS chembl;


.print Add column 'standard_inchi_key' to table 'chembl_snapshot' and fill it with data from the ChEMBL database
ALTER TABLE chembl_snapshot
ADD COLUMN standard_inchi_key VARCHAR(27);

UPDATE chembl_snapshot
SET standard_inchi_key = (
  SELECT cs.standard_inchi_key
  FROM compound_structures cs
  JOIN molecule_dictionary md ON md.molregno = cs.molregno
  WHERE chembl_snapshot.chembl_id = md.chembl_id
);


.print Add concatenation column 'tucan_plus_inchi_key_first_layer' to table 'chembl_snapshot' and fill it with data (concatenate TUCAN string and InChIKey first layer)
ALTER TABLE chembl_snapshot
ADD COLUMN tucan_plus_inchi_key_first_layer TEXT;

UPDATE chembl_snapshot
SET tucan_plus_inchi_key_first_layer = (
  SELECT snapshot.tucan || SUBSTR(snapshot.standard_inchi_key, 1, 14)
  FROM chembl_snapshot snapshot
  WHERE snapshot.chembl_id = chembl_snapshot.chembl_id
);


.print Show compounds with duplicate TUCAN strings, but exclude those with identical InChIKey first layer
SELECT chembl_id, tucan, standard_inchi_key
FROM chembl_snapshot
WHERE tucan IN (
  SELECT tucan FROM (
    SELECT tucan
    FROM chembl_snapshot
    GROUP BY tucan_plus_inchi_key_first_layer
    HAVING COUNT(tucan_plus_inchi_key_first_layer) = 1
  )
  GROUP BY tucan
  HAVING COUNT(tucan) > 1
);
