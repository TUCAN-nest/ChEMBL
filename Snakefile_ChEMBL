from chembl_db import create_sdf
from tucan.canonicalization import canonicalize_molecule
from tucan.serialization import serialize_molecule
from tucan.io import graph_from_molfile_text
from tucan.graph_utils import permute_molecule
import random

##############
# Parameters #
##############

# Number of compounds in the database
NUM_MOLFILES = 2304875

# Number of compounds to be processed iteratively within one chunk
MOLFILES_PER_CHUNK = 1000

###############
# Python code #
###############
CHUNKS = NUM_MOLFILES // MOLFILES_PER_CHUNK + 1
CHUNK_SIZE = NUM_MOLFILES // CHUNKS + 1

# from TUCAN/tests/test_canonicalization.py
def test_invariance(molfile, chembl_id, n_runs=10, random_seed=random.random()):
  m = graph_from_molfile_text(molfile)

  m_canon = canonicalize_molecule(m)
  m_serialized = serialize_molecule(m_canon)
  random.seed(random_seed)
  for _ in range(n_runs):
    permutation_seed = random.random()
    m_permu = permute_molecule(m, random_seed=permutation_seed)
    m_permu_canon = canonicalize_molecule(m_permu)
    m_permu_serialized = serialize_molecule(m_permu_canon)
    if m_serialized != m_permu_serialized:
      return "invariance test failed for %s\n" % chembl_id
  return ""


def execInvarianceTestForMolecule(molfile, output, chembl_id):
  result = test_invariance(molfile, chembl_id)
  with open(output, "a") as file:
    file.write(result)


def execInvarianceTestForChunk(input, output):
  supplier = Chem.SDMolSupplier(fileName=input, removeHs=False)
  for molecule in supplier:
    molfile = Chem.MolToMolBlock(mol = molecule, forceV3000 = True)
    chembl_id = molecule.GetProp("chembl_id")
    execInvarianceTestForMolecule(molfile, output, chembl_id)


###################
# Snakemake rules #
###################
rule download_chembl_sqlite:
  output:
    "chembl_31_sqlite.tar.gz"
  shell:
    "curl https://ftp.ebi.ac.uk/pub/databases/chembl/ChEMBLdb/releases/chembl_31/chembl_31_sqlite.tar.gz -o {output}"


rule extract_chembl_sqlite:
  input:
    "chembl_31_sqlite.tar.gz"
  output:
    "chembl_31/chembl_31_sqlite/chembl_31.db"
  shell:
    "tar -xzf {input}"


# Creates a sdf file with V3000 molfiles for the given chunk number
rule molfiles_from_db_for_chunk:
  input:
    "chembl_31/chembl_31_sqlite/chembl_31.db"
  output:
    "chembl_31/molfiles/{chunk}.sdf"
  params:
    chunk_start = lambda wildcards: (int(wildcards.chunk) - 1) * CHUNK_SIZE + 1,
    chunk_end = lambda wildcards: int(wildcards.chunk) * CHUNK_SIZE
  run:
    create_sdf(input[0], output[0], params.chunk_start, params.chunk_end)


rule test_invariance_for_chunk:
  input:
    "chembl_31/molfiles/{chunk}.sdf"
  output:
    "chembl_31/logs/{chunk}.log"
  run:
    execInvarianceTestForChunk(input[0], output[0])


rule aggregate_logfiles:
  input:
    expand("chembl_31/logs/{chunk}.log", chunk=range(1, CHUNKS + 1))
  output:
    "chembl_31/test_invariance.log"
  shell:
    "find chembl_31/logs/ -name '*.log' -exec cat {{}} >> {output} \;"


rule test_invariance:
  input:
    "chembl_31/test_invariance.log"
